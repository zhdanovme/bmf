# BMF - Business Model Format

A specification format for defining mobile app business logic, screens, entities, and workflows.

## Project Structure

```
bmf/
├── viewer/           # React-based BMF viewer application
├── bmfs/             # BMF specification projects
│   ├── template/     # BMF templates and examples
│   │   ├── *.yaml        # Entity templates (action, screen, entity, etc.)
│   │   ├── _epics.yaml   # Epic template
│   │   ├── _test-cases.yaml  # Test case template
│   │   └── _comments.yaml    # Comments template
│   └── {project}/    # Individual project specs
│       ├── *.yaml           # Spec files (entities, screens, actions, etc.)
│       ├── _epics.yaml      # Feature epics
│       ├── _test-cases.yaml # Test scenarios
│       └── _comments.yaml   # Comments for spec review
├── utils/            # Utility scripts for BMF management
└── .claude/
    └── commands/     # Claude Code slash commands
```

## Running the Viewer

### Development Mode

```bash
cd viewer
npm install
npm run dev
```

Open http://localhost:5173 in your browser.

### Production Build

```bash
cd viewer
npm run build
npm run preview
```

### Using the Viewer

1. Click **"Open Spec Folder"** to select a BMF project directory
2. The viewer will load all `.yaml` files and display the navigation graph
3. Click on nodes to view entity details
4. Press **C** to add/edit comments on selected entities
5. Comments are automatically saved to `_comments.yaml` in the project folder

## Claude Code Commands

### `/bmf.comments {project}`

Review and resolve comments in a BMF specification.

```bash
/bmf.comments marketplace
```

**Behavior:**

- Loads comments from `bmfs/{project}/_comments.yaml`
- Reviews each unresolved comment
- **Resolves by default** if the specification is clear
- Only keeps comments open if clarification is genuinely needed
- Saves changes back to `_comments.yaml`

**Output:**

- Summary of total/resolved/open comments
- Resolution notes for each processed comment

### `/bmf.create-epics {folder} [lang]`

Generate `_epics.yaml` for a BMF project by analyzing its YAML structure.

```bash
/bmf.create-epics bmfs/examples/marketplace
/bmf.create-epics bmfs/myproject ru
```

**Behavior:**

- Analyzes all `.yaml` files in the specified folder
- Groups entities by domain (epic namespace)
- Generates epic descriptions based on entity content
- Creates subepics for domains with 3+ related entities
- Supports multiple languages (`en`, `ru`)

**Output:**

- Creates `{folder}/_epics.yaml` with epic definitions
- Summary of epics created by domain

### `/bmf.create-tcs {folder} [lang]`

Generate test cases (`_test-cases.yaml`) from epics and tag entities with `tc:*` markers.

```bash
/bmf.create-tcs bmfs/examples/marketplace
/bmf.create-tcs bmfs/myproject ru
```

**Behavior:**

- Requires `_epics.yaml` to exist (run `/bmf.create-epics` first)
- Cleans existing `tc:*` tags before generating new ones
- Analyzes entity relationships and navigation flows
- Generates happy path, edge case, and alternative path scenarios
- Tags entities with `tc:epic:scenario`, `tc:epic:scenario:start`, `tc:epic:scenario:end`
- Runs coverage check to ensure all required entities are covered

**Output:**

- Creates/updates `{folder}/_test-cases.yaml`
- Tags entities in spec files with `tc:*` markers
- Coverage report showing covered/uncovered entities

## Comments System

Comments are stored in `_comments.yaml` within each project folder:

```yaml
# BMF Comments
# Generated by BMF Viewer

entity:users:user:
  text: "Need to add email validation"
  createdAt: 1704067200000
  resolved: false

screen:home:main:
  text: "Missing loading state"
  createdAt: 1704067200000
  resolved: true
  resolution: "Added loading component"
  questions:
    - question: "Should we show a spinner or skeleton?"
      answer: "Use skeleton loader for better UX"
```

### Comment Fields

| Field | Type | Description |
|-------|------|-------------|
| `text` | string | Main comment content |
| `createdAt` | number | Unix timestamp (milliseconds) |
| `resolved` | boolean | Whether the comment is resolved |
| `resolution` | string | Optional resolution notes |
| `questions` | array | Q&A thread for discussions |

## BMF Spec Format

BMF specs use YAML files organized by entity type:

- `entities/*.yaml` - Data models
- `screens/*.yaml` - UI screens
- `actions/*.yaml` - Business logic actions
- `dialogs/*.yaml` - Modal dialogs
- `components/*.yaml` - Reusable UI components
- `context.yaml` - Global app context and triggers
- `actors.yaml` - User roles and permissions

## Utilities

Command-line utilities for BMF management. All utilities are run with `npx ts-node`.

### `validate-schema.ts`

Validate BMF spec files against the JSON schema.

```bash
npx ts-node utils/validate-schema.ts bmfs/{project}
```

### `check-references.ts`

Check for broken references between entities.

```bash
npx ts-node utils/check-references.ts bmfs/{project}
```

### `check-tcs.ts`

Check test case coverage. Reports which entities are covered by `tc:*` tags and which are missing coverage.

```bash
npx ts-node utils/check-tcs.ts bmfs/{project}
```

**Output:**

- Summary of test cases defined
- Coverage by entity type (screen, dialog, action, event)
- List of uncovered required entities (must be fixed)
- List of orphan `tc:*` tags (referencing undefined test cases)

### `delete-tc-tags.ts`

Remove all `tc:*` tags from entity files. Useful for regenerating test case coverage from scratch.

```bash
npx ts-node utils/delete-tc-tags.ts bmfs/{project}
```

### `tag-entities.ts`

Apply predefined test case tags to entities. Contains hardcoded mappings of test case IDs to entity tags.

```bash
npx ts-node utils/tag-entities.ts bmfs/{project}
```

## Development

### Viewer Tech Stack

- React 18
- TypeScript
- Zustand (state management)
- XY Flow (graph visualization)
- Vite (build tool)

### Running Tests

```bash
cd viewer
npm test
npm run test:e2e
```
